{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-7">
        <div class="glass-card p-4 text-center">
            
            {% if status == 0 or status == 3 %}
                {% if status == 3 %}
                    <i class="bi bi-x-circle display-1 text-danger mb-3"></i>
                    <h2 class="text-danger fw-bold">Rejected</h2>
                    <div class="alert alert-danger text-start">{{ reason }}</div>
                    <p>Please try again:</p>
                {% else %}
                    <i class="bi bi-person-badge display-1 text-warning mb-3"></i>
                    <h2 class="text-white">Identity Verification</h2>
                    <p class="text-white-50">Upload a document or take a photo of your face.</p>
                {% endif %}

                <hr class="border-secondary">

                <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active btn-glass me-2" id="pills-upload-tab" data-bs-toggle="pill" data-bs-target="#pills-upload" type="button">
                            <i class="bi bi-folder2-open"></i> Upload File
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link btn-glass" id="pills-camera-tab" data-bs-toggle="pill" data-bs-target="#pills-camera" type="button">
                            <i class="bi bi-camera-video"></i> Webcam
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-upload">
                        <form method="POST" enctype="multipart/form-data" class="mt-4">
                            <div class="mb-3">
                                <label class="form-label text-white-50">Select Passport/ID Photo:</label>
                                <input type="file" name="document" class="form-control" required>
                            </div>
                            <button class="btn btn-success w-100 py-3 rounded-pill fw-bold">
                                <i class="bi bi-upload"></i> Upload File
                            </button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="pills-camera">
                        <div class="mt-3">
                            <div id="camera-area" style="display: none;">
                                <video id="video" width="100%" height="auto" autoplay style="border-radius: 15px; border: 2px solid white;"></video>
                                <canvas id="canvas" style="display:none;"></canvas> 
                                <button id="snap-btn" class="btn btn-info w-100 mt-2 py-2 fw-bold rounded-pill">
                                    <i class="bi bi-camera"></i> Capture & Send
                                </button>
                            </div>

                            <div id="start-area">
                                <p class="text-white-50">The browser will request access to your camera.</p>
                                <button onclick="startCamera()" class="btn btn-outline-light w-100 py-3 rounded-pill">
                                    <i class="bi bi-power"></i> Enable Camera
                                </button>
                            </div>
                            
                            <form method="POST" id="webcam-form">
                                <input type="hidden" name="webcam_image" id="webcam-input">
                            </form>
                        </div>
                    </div>

                </div>

            {% elif status == 1 %}
                <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;"></div>
                <h2 class="text-warning">Verifying...</h2>
                <p class="lead">We are reviewing your photo. Please wait.</p>
                <button onClick="window.location.reload();" class="btn btn-glass btn-sm">Refresh Page</button>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snap-btn');
    const startArea = document.getElementById('start-area');
    const cameraArea = document.getElementById('camera-area');
    const webcamInput = document.getElementById('webcam-input');
    const webcamForm = document.getElementById('webcam-form');

    // 1. Start Camera
    function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    video.play();
                    startArea.style.display = 'none';
                    cameraArea.style.display = 'block';
                })
                .catch(function (error) {
                    alert("Camera access error! Please check browser permissions.");
                    console.log(error);
                });
        } else {
            alert("Your browser does not support the webcam :(");
        }
    }

    // 2. Capture and Send (Optimized JPEG)
    snapBtn.addEventListener("click", function() {
        const context = canvas.getContext('2d');
        
        // Resize logic to avoid 413 Payload Error
        const targetWidth = 800;
        const scaleFactor = targetWidth / video.videoWidth;
        const targetHeight = video.videoHeight * scaleFactor;

        canvas.width = targetWidth;
        canvas.height = targetHeight;
        
        context.drawImage(video, 0, 0, targetWidth, targetHeight);

        // Compress to JPEG (0.8 quality)
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        
        webcamInput.value = dataURL;
        webcamForm.submit();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}